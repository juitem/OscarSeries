# compareCSV: Tool for ELF Section CSV Comparison

## Overview

This tool compares ELF section CSV files (old and new versions) to generate wide diff CSVs at the file level, Top-N summaries, and **group-wise total reports in Markdown** format. Sections are mapped to groups either by name-based patterns or **JSON rules**, and byte sums are compared at the group level.

## Input and Output

### Input

- Old CSV and New CSV: generated by `elfinfo.py`
- Required columns: `relative_path` or `base_rel_dir` (at least one), `filename`, `section_name`, `section_size`
- Optional columns (used if present): `section_type`, `section_flags_perms`, `is_nobits`, `in_load_segment`, `load_segment_rwx`, `addr_space`
- Optional Config JSON: defines groups, rules, output options, etc.

### Output

- (Optional) Whole-file diff CSV: records old/new/diff/diff% columns for all groups per file side-by-side
- Top-N Groups CSV/Markdown: group-wise total old/new/diff/diff% sorted by metric and limited to top N
- Top-N Files CSV: file ranking for each top group
- Groups Report Markdown: lists sections per group, total old/new/diff/diff%, aggregated extended attributes (value(count) format), includes executed command line at the top
- Top files list: list of files for downstream pipeline usage

Output filenames include suffixes depending on `--output-prefix` and `--target-files` values (`ALL`, `COMMON`, `ADDED+REMOVED`). The Markdown files include target labels and the executed command line at the top.

## Main Features and Workflow

### Full Pipeline

#### CSV Loading and Normalization

- Validate required columns
- Preserve extended fields (replace pipe `|` characters to avoid conflicts)

#### Group Resolver Creation (`build_group_resolver(groups, rules)`)

- Combines name-based groups (patterns) and JSON rules
- Matching order:
  1. First match by name-based patterns
  2. First match by JSON rules
  3. Default group if no match

#### Aggregation

- `aggregate_by_file_and_group`: sums section sizes by `(relative_path, filename)` × group
- `collect_group_sections`: gathers actual section names per group
- `collect_group_section_attrs`: aggregates extended attributes per group as Counters (value counts)

#### Key Joining

- `compute_joined_keys`: determines intersection/union/symmetric difference of keys based on `target_mode`

#### Output Generation

- (Optional) `write_diff_csv`: whole-file CSV with wide diff columns
- `compute_topn`: generates Top-N data
- `write_topn_groups_csv`, `write_topn_files_csv`, Top-N Markdown reports
- `write_groups_report_md`: full report including extended attributes
- `write_topfiles_used`: list of top files for further processing

## Group Mapping Rules (Core Logic)

- Priority order:
  1. Name-based groups: return first matching group using `fnmatch(section_name, pattern)` in order
  2. JSON rules: return first matching rule’s group where all `if` conditions (AND) match; conditions accept strings or arrays, matched via `fnmatch` (supports exact and wildcard)
  3. Default group: applied only if no match above

- Available keys for rules: `section_name`, `filename`, `section_flags_perms`, `addr_space`, `section_type`, `is_nobits`, `in_load_segment`, etc.

- Default group rule: remove leading `.` from `section_name` then uppercase entire string  
  Example: `.rodata.str1.1` → `RODATA.STR1.1`

- Single membership: only first match (either by name or rule) is assigned; default group is not added if matched earlier.

## Extended Attribute Aggregation

- `collect_group_section_attrs`: aggregates attribute values per group using `Counter`
- In reports, values are displayed in `Value(Count)` format, e.g., `A(3) WA(2)`
- To avoid Markdown table corruption, pipe characters `|` are removed from values

## CLI and Configuration

### CLI Core Options

- `--old-csv`, `--new-csv`: input CSV files
- `--target-files={all,common,added+removed}`: file key set for comparison
  - `all`: union
  - `common`: intersection (default)
  - `added+removed`: symmetric difference (added and removed only)
- `--whole-filedata-csv PATH`: path to save wide diff CSV per file (default name if unspecified)
- `--gen-whole-filedata-csv={true|false}`: control generating wide CSV (default recommended `true`; code default may be `false` so config override is advised)
- `--top-n-groups`, `--top-n-files`, `--group-sort-by`, `--group-sort-metric`
- `--files-sort-by`, `--files-sort-metric`: sorting keys for wide CSV rows
- `--output-prefix`, `--out-dir`, `--config-file`
- Deprecated options: `--all-files`, `--files-csv`, `--groups-csv`, `--top-n`

### Config JSON Core Keys

- `target_files`: `"all"`, `"common"`, or `"added+removed"`
- `whole_filedata_csv`: default output path
- `gen_whole_filedata_csv`: `"true"` or `"false"`
- Sorting and Top-N parameters: `files_sort_by`, `files_sort_metric`, `top_n_groups`, `top_n_files`, `group_sort_by`, `group_sort_metric`
- `groups`: dictionary mapping group names to lists of patterns  
  - Dictionary order defines priority for name-based matching
- `rules`: list of rules with conditions and group assignment  
  - Order defines priority  
  - Example rule: `{ "if": { "section_flags_perms": ["A?X", "AX"], "addr_space": "PA+VA" }, "group": "TEXT" }`

### Matching Priority Summary

- Name-based patterns → JSON rules → Default group
- Only the first match in name-based or rules is used

## Data Model

- Keys: `(relative_path, filename)`
- Group sums: Map from `(rel_path, filename)` to `{ group → sum(section_size) }`
- Section and attribute aggregation:
  - `group_sections`: Map from group to set of section names
  - `group_attrs`: Map from group to Map of attribute → Counter of values

## Algorithm and Logic Details

### Key Joining

- `all`: union of old and new keys
- `common`: intersection of old and new keys
- `added+removed`: symmetric difference = (old ∪ new) − (old ∩ new)

### Sorting

- Wide CSV: sort file rows by absolute difference (`|diff|`) or selected metric
- Top-N Groups: sort by selected metric such as absolute diff

## Output Formats

### Whole-file Diff CSV (Optional)

- Columns: `relative_dir`, `filename`, `status`, `<Group>_old`, `<Group>_new`, `<Group>_diff`, `<Group>_diff%`, ...
- `status`: one of `Common`, `Added`, `Removed`

### Top-N Groups Markdown

- Header includes `target: ...`
- Executed command line shown at the top in a bash code block
- Table columns: `Group | Total Old | Total New | Total Diff | Diff%`
- `FILESIZE` column is placed first for prominence

### Groups Report Markdown

- Header includes `target: ...`
- Executed command line shown at the top in a bash code block
- Table columns:  
  `Group | Sections | Total Old | Total New | Total Diff | Diff% | section_type | section_flags_perms | is_nobits | in_load_segment | load_segment_rwx | addr_space`
- Attribute values displayed as `Value(Count)` with pipes removed

## Error Handling

- Config parsing failure or malformed structure: prints `[ERROR]` message and exits
- Missing required CSV columns: raises exception with descriptive message
- No keys to compare: exits with `SystemExit("No files to compare ...")`

## Performance and Scalability

- Single pass aggregation ensures linear scaling with file count
- Uses `Counter` and `defaultdict` to minimize aggregation overhead
- Adding extended fields is automatic by adding columns in CSV
- Rule engine is lightweight and based on `fnmatch`; can be replaced with regex if needed

## Test Checklist

- Validate input CSVs including edge cases (empty values, zero sizes, flags containing pipes)
- Verify key sets for all three `--target-files` modes
- Confirm priority order: name-based first, then rules, then default group
- Test rules with multiple patterns (OR), multiple keys (AND), and empty string matching
- Check Markdown tables avoid corruption by removing pipe characters
- Confirm no CSV generation when `--gen-whole-filedata-csv=false` and appropriate log messages
- Check deprecated options produce warnings and maintain compatibility

## Example Rules (JSON)

```json
{
  "target_files": "all",
  "groups": {
    "TEXT": [".text", ".text.*"]
  },
  "rules": [
    { "if": { "section_flags_perms": ["A?X", "AX"], "addr_space": "PA+VA" }, "group": "TEXT" },
    { "if": { "section_flags_perms": "" }, "group": "CUSTOM_IGNORE" }
  ]
}
```

## Maintenance and Change Points

- Matching priority is controlled in `build_group_resolver().resolve()`
- Default group naming rule is in `default_group_name()` (removes leading `.`)
- Target file mode logic is in `compute_joined_keys()`
- Report headers, naming, and command line printing handled in `write_groups_report_md()` and Top-N generation code

## Future Improvement Ideas

- Add priority/policy options for rules (e.g., `rules_precedence`, match modes like `first`, `last`, `all`)
- Support regex matching option in rules (`use_regex: true`)
- Normalize extended attributes (e.g., boolean conversion, aliasing like `AX`/`WA`)
- Parallel or streaming aggregation for large datasets (file-level partitioning)
